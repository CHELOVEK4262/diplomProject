<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Расчет затрат на рейс</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="icon" href="img/logo.svg" type="image/x-icon"/>

    <script src="Db.js"></script>
</head>
<body>
    <div class="menu">
        <div class="container_1">
            <form id="distance-form">
                <div class="autocomplete-container">
                    <label for="start">Пункт загрузки:</label>
                    <input type="text" id="start" placeholder="Введите адрес начальной точки" required autocomplete="off">
                    <div style="z-index: 100;" id="start-suggestions" class="suggestions"></div>
                </div>
                <br><br>
                <div class="autocomplete-container">
                    <label for="end">Пункт выгрузки:</label>
                    <input type="text" id="end" placeholder="Введите адрес конечной точки" required autocomplete="off">
                    <div style="z-index: 80;" id="end-suggestions" class="suggestions"></div>
                </div>
                <br>
                <button style="width: 200px;" type="submit">Рассчитать</button>
            </form>
        </div>

        <div class="container_2">
            <div onclick="openModal()" class="add_in_favarit"><img style="width: 25px; height: 25px;" src="img/favourite.webp" alt="избранное"></div>
        </div>

        <script>
            function openModal()
            {
                document.getElementById("modal").style.display = "unset";
            }

            function closeModal()
            {
                document.getElementById("modal").style.display = "none";
            }
        </script>

        <div class="modal" id="modal">
            <div class="modalButtonsDiv">
                <button class="modalButton">Добавить</button>
                <button class="modalButton">Редактировать</button>
                <button id="deleteButton" class="modalButton">Удалить</button>
                <button class="modalButton">Использовать</button>
            </div>
            <div class="modalTable" style="height: 470px;">
                <table class="routesTable" cellspacing=0 style="width: 550px;">
                    <thead><tr>
                        <th>Пункт загрузки</th>
                        <th>Пункт выгрузки</th>
                    </tr></thead>
                    <tbody>
                        <% routes.forEach(route => { %>
                            <tr>
                                <td><%= route.StartLocation %></td>
                                <td><%= route.EndLocation %></td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>

                <script>
                    const table = document.querySelector('.routesTable');
                    const deleteButton = document.getElementById('deleteButton');
                    let selectedRow = null;
            
                    // Обработчик клика по строкам таблицы
                    table.addEventListener('click', (event) => {
                        const clickedRow = event.target.closest('tr');
                        if (!clickedRow || clickedRow.tagName === 'THEAD') return;
            
                        // Убираем выделение со всех строк
                        document.querySelectorAll('.routesTable tr').forEach(row => {
                            row.classList.remove('selected');
                        });
            
                        // Выделяем выбранную строку
                        clickedRow.classList.add('selected');
                        selectedRow = clickedRow;
            
                        // Активируем кнопку удаления
                        deleteButton.disabled = false;
                    });
            
                    // Обработчик клика по кнопке "Удалить"
                    deleteButton.addEventListener('click', () => {
                        if (!selectedRow) return;
            
                        const StartLocation = selectedRow.dataset.StartLocation;
                        const EndLocation = selectedRow.dataset.EndLocation;
            
                        fetch('/delete-route', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ StartLocation: StartLocation, EndLocation: EndLocation }),
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Ошибка при удалении маршрута');
                                }
                                // Удаляем строку из таблицы
                                selectedRow.remove();
                                selectedRow = null;
                                deleteButton.disabled = true;
                            })
                            .catch(err => {
                                console.error(err);
                                alert('Не удалось удалить маршрут');
                            });
                    });
                </script>

            </div>
            <div class="closeButton" onclick="closeModal()">
                <img src="img/close-sign.png" style="height: 20px;">
            </div>
        </div>

        <div class="options">
            <div>
                <label class="options-input">Автомобиль</label>
                <select class="options-dropdown" id="truck-dropdown">
                    <% trucks.forEach(truck => { %>
                        <option value="<%= truck.fuel_efficiency %>">
                            <%= truck.TruckName %> [<%= truck.TruckRegNumber%>] (<%= truck.TruckFuelUsage %> л/100 км)
                        </option>
                    <% }) %>
                </select>
            </div>
            <div style="margin-top: 11px;">
                <label class="options-input">Стоимость топлива (за литр)</label>
                <input class="options-input" type="number" id="fuel-cost" value="0.00" step="0.01">
            </div>
            <div>
                <label class="options-input">Стоимость платных дорог</label>
                <input class="options-input" type="number" id="toll-cost" value="0.00" step="0.01">
            </div>
        </div>
        <div class="options">
            <div>
                <label class="options-input">Стоимость стоянок</label>
                <input class="options-input" type="number" id="parking-cost" value="0.00" step="0.01">
            </div>
            <div style="padding-top: 18px;">
                <label class="options-input">Питание водителя</label>
                <input class="options-input" type="number" id="driver-food" value="0.00" step="0.01">
            </div>
        </div>
            <div class="history-table">
                <table cellspacing=0>
                    <thead><tr>
                        <th>Дата</th>
                        <th>Загрузка</th>
                        <th>Выгрузка</th>
                        <th>Расстояние</th>
                        <th>Стоимость</th>
                        <th>Автомобиль</th>
                    </tr></thead>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                        <td>5</td>
                        <td>6</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                        <td>5</td>
                        <td>6</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                        <td>5</td>
                        <td>6</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                        <td>5</td>
                        <td>6</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                        <td>5</td>
                        <td>6</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                        <td>5</td>
                        <td>6</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                        <td>5</td>
                        <td>6</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                        <td>5</td>
                        <td>6</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                        <td>5</td>
                        <td>6</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                        <td>5</td>
                        <td>6</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                        <td>5</td>
                        <td>6</td>
                    </tr>
                    <tr>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                        <td>5</td>
                        <td>6</td>
                    </tr>
                </table>
            </div>
    </div>

    <h3>Готовые расчеты:</h3>
    <p id="output"><strong>Расстояние: </strong><span id="total-dist">0.00</span> км.</p>
    <p id="output"><strong>Итоговая стоимость: </strong><span id="total-cost">0.00</span> руб.</p>

    <div style="z-index: 50;" id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="/js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let distance = 0; // Расстояние в км

            function calculateCosts() {
                // Получаем значения из формы
                const fuelCost = parseFloat(document.getElementById('fuel-cost').value) || 0;
                const tollCost = parseFloat(document.getElementById('toll-cost').value) || 0;
                const parkingCost = parseFloat(document.getElementById('parking-cost').value) || 0;
                const driverFood = parseFloat(document.getElementById('driver-food').value) || 0;
                const fuelUsage = parseFloat(document.getElementById('truck-dropdown').value) || 0;

                // Проверяем, что расстояние известно
                if (distance <= 0) {
                    document.getElementById('total-cost').innerText = '0.00';
                    return;
                }

                // Расчет стоимости топлива
                const fuelExpenses = (distance * fuelUsage / 100) * fuelCost;

                // Общая стоимость рейса
                const totalCost = fuelExpenses + tollCost + parkingCost + driverFood;

                // Обновляем вывод
                document.getElementById('total-cost').innerText = totalCost.toFixed(2);
                document.getElementById('total-dist').innerText = distance.toFixed(2);
            }

            // Связываем расчет с изменением значений
            document.getElementById('distance-form').addEventListener('submit', function (e) {
                e.preventDefault();
                calculateCosts();
            });

            // Интеграция с картой
            window.calculateDistance = function(map, startCoords, endCoords) {
                if (!startCoords || !endCoords) {
                    alert('Не заданы обе точки для маршрута.');
                    return;
                }

                map.eachLayer(function (layer) {
                    if (layer instanceof L.Polyline) {
                        map.removeLayer(layer);
                    }
                });

                fetch(`https://router.project-osrm.org/route/v1/driving/${startCoords[1]},${startCoords[0]};${endCoords[1]},${endCoords[0]}?overview=full&geometries=geojson`)
                    .then(response => response.json())
                    .then(routeData => {
                        if (routeData.routes.length === 0) {
                            alert('Не удалось построить маршрут.');
                            return;
                        }

                        const route = routeData.routes[0];
                        distance = route.distance / 1000; // В километрах

                        const routeCoords = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        const polyline = L.polyline(routeCoords, { color: 'blue' }).addTo(map);
                        map.fitBounds(polyline.getBounds());

                        // Автоматический расчет при обновлении маршрута
                        calculateCosts();
                    });
            };
        });
    </script>
</body>
</html>
